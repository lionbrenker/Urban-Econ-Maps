<!DOCTYPE html>
<html>
<head>
    <title>Urban Econ Maps</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- MapLibre GL JS CSS -->
    <link href='https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css' rel='stylesheet' />
    <!-- MapLibre GL JS -->
    <script src='https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js'></script>
    <!-- Turf.js for GIS operations -->
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    
    <!-- Our New Styles -->
    <style>
        <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            width: 250px;
        }
    </style>
</head>
<body>

    <!-- The map container, which will fill the whole page -->
    <div id="map"></div>

    <!-- The HTML for our new floating control panel -->
    <div id="panel">
        <h2>Frankfurt Data</h2>
        
        <div id="city-selector">
            <h4>Select City:</h4>
            <select id="city-dropdown" style="width: 100%;"></select>
        </div>
        <hr> <!-- This adds a nice dividing line -->
        
        <div class="layer-control">
            <h4>Select Data Layer:</h4>
            <input type="radio" id="housing" name="layer" value="housing_price" checked>
            <label for="housing">Housing Prices (€/m²)</label><br>
            <input type="radio" id="population" name="layer" value="population_density">
            <label for="population">Population Density</label><br>
        </div>
    </div>

    <script>
        // --- 1. INITIALIZE THE MAP ---
        const map = new maplibregl.Map({
            container: 'map',
            style: `https://api.maptiler.com/maps/streets/style.json?key=8UPX2x4HfWayBX8z6OFn`,
            center: [10.4515, 51.1657], // Center of Germany
            zoom: 5 // Zoomed out to see the whole country
        });
        
        // --- GLOBAL VARIABLE to hold all our region data ---
        let allRegionsData = null;
        
        // --- 2. CITY SELECTION LOGIC ---
        const cityDropdown = document.getElementById('city-dropdown');
        
        // This function will be called once the GeoJSON is loaded
        function populateDropdown(geojsonData) {
            // Clear any existing options
            cityDropdown.innerHTML = '';
        
            // --- NEW: Create a sorted copy of the features ---
            const sortedFeatures = [...geojsonData.features].sort((a, b) => {
                // Using the key you provided: krs_name_short
                const nameA = a.properties.krs_name_short;
                const nameB = b.properties.krs_name_short;
                // localeCompare is the best way to sort strings alphabetically, especially in German
                return nameA.localeCompare(nameB);
            });
            // --- End of new code ---
        
            // Loop through the NEW sorted array
            sortedFeatures.forEach(feature => {
                const option = document.createElement('option');
                const regionName = feature.properties.krs_name_short;
                
                // The value is now the region's name, not its index
                option.value = regionName;
                option.innerText = regionName;
                cityDropdown.appendChild(option);
            });
        }
        
        // Function to handle city selection change (now finds by name)
        function selectRegionByName(name) {
            if (!allRegionsData) return; // Make sure data is loaded
        
            // --- NEW: Find the feature in our original data that has the matching name ---
            const selectedFeature = allRegionsData.features.find(feature => feature.properties.krs_name_short === name);
        
            if (!selectedFeature) {
                console.error("Could not find region:", name);
                return;
            }
            // --- End of new code ---
        
            // Use Turf.js to calculate the center of the selected region
            const center = turf.centerOfMass(selectedFeature).geometry.coordinates;
        
            // Smoothly move the map to the new region's center
            map.flyTo({
                center: center,
                zoom: 9,
                essential: true
            });
        
            // Update the 'city-border-source' with ONLY the selected region's data
            map.getSource('city-border-source').setData(selectedFeature.geometry);
        }
        
        // Change it to this:
        cityDropdown.addEventListener('change', (e) => {
            selectRegionByName(e.target.value);
        });
        
        
        // --- 3. MAP LOAD AND DATA FETCHING ---
        map.on('load', () => {
            // --- SETUP SOURCES AND LAYERS (these are initially empty) ---
            map.addSource('city-border-source', { 'type': 'geojson', 'data': null });
            map.addLayer({
                'id': 'city-border-layer',
                'type': 'line',
                'source': 'city-border-source',
                'paint': { 'line-color': '#0000ff', 'line-width': 4, 'line-dasharray': [2, 2] }
            });
            
            // (The highlight layers can remain for future use)
            map.addSource('highlight-building-source', { 'type': 'geojson', 'data': null });
            map.addLayer({ 'id': 'highlight-building-layer', 'type': 'fill', 'source': 'highlight-building-source', 'paint': { 'fill-color': '#f08', 'fill-opacity': 0.6 }});
            map.addSource('highlight-road-source', { 'type': 'geojson', 'data': null });
            map.addLayer({ 'id': 'highlight-road-layer', 'type': 'line', 'source': 'highlight-road-source', 'paint': { 'line-color': '#33f', 'line-width': 4 }});
        
            // --- FETCH THE MAIN GEOJSON DATA ---
            fetch('germany-regions.geojson')
                .then(response => response.json())
                .then(data => {
                    console.log("GeoJSON data loaded successfully");
                    allRegionsData = data; // Store the data globally
                    populateDropdown(allRegionsData); // Populate the dropdown
                    selectRegionByName(cityDropdown.value);
                });
                
            // --- CLICK HANDLER CAN REMAIN FOR FUTURE USE ---
            map.on('click', (e) => {
                const possibleLayers = ['building', 'building-3d', 'road_major', 'road_minor', 'road_street', 'road_motorway', 'road_path', 'transportation'];
                const features = map.queryRenderedFeatures(e.point, { layers: possibleLayers });
                if (!features.length) { return; }
                const clickedFeature = features[0];
                const layerId = clickedFeature.layer.id;
                if (layerId.includes('building')) {
                    map.getSource('highlight-building-source').setData(clickedFeature.geometry);
                } else if (layerId.includes('road') || layerId.includes('transportation')) {
                    map.getSource('highlight-road-source').setData(clickedFeature.geometry);
                }
            });
        });

    </script>

</body>
</html>
