<!DOCTYPE html>
<html>
<head>
    <title>Urban Econ Maps</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- MapLibre GL JS CSS -->
    <link href='https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css' rel='stylesheet' />
    <!-- MapLibre GL JS -->
    <script src='https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js'></script>
    
    <!-- Our New Styles -->
    <style>
        <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            width: 250px;
        }
    </style>
</head>
<body>

    <!-- The map container, which will fill the whole page -->
    <div id="map"></div>

    <!-- The HTML for our new floating control panel -->
    <div id="panel">
        <h2>Frankfurt Data</h2>
        
        <div id="city-selector">
            <h4>Select City:</h4>
            <select id="city-dropdown" style="width: 100%;"></select>
        </div>
        <hr> <!-- This adds a nice dividing line -->
        
        <div class="layer-control">
            <h4>Select Data Layer:</h4>
            <input type="radio" id="housing" name="layer" value="housing_price" checked>
            <label for="housing">Housing Prices (€/m²)</label><br>
            <input type="radio" id="population" name="layer" value="population_density">
            <label for="population">Population Density</label><br>
        </div>
    </div>

    <script>
        // --- DATA FOR OUR CITIES ---
        const CITIES = {
            'frankfurt': {
                name: 'Frankfurt',
                center: [8.6821, 50.1109], // [longitude, latitude]
                zoom: 11,
                border_file: 'frankfurt-border.geojson'
            },
            'berlin': {
                name: 'Berlin',
                center: [13.4050, 52.5200],
                zoom: 10,
                border_file: 'berlin-border.geojson' // (You would need to create this file)
            }
            // Add more cities here in the future
        };
                
        // --- 1. INITIALIZE THE MAP ---
        const map = new maplibregl.Map({
            container: 'map',
            style: `https://api.maptiler.com/maps/streets/style.json?key=8UPX2x4HfWayBX8z6OFn`,
            center: CITIES.frankfurt.center, // Start at our default city
            zoom: CITIES.frankfurt.zoom
        });
        
        
        // --- 2. CITY SELECTION LOGIC ---
        const cityDropdown = document.getElementById('city-dropdown');
        
        // Populate the dropdown from our CITIES object
        for (const cityKey in CITIES) {
            const option = document.createElement('option');
            option.value = cityKey;
            option.innerText = CITIES[cityKey].name;
            cityDropdown.appendChild(option);
        }
        
        // Function to handle city selection change
        function selectCity(cityKey) {
            const city = CITIES[cityKey];
            
            // Smoothly move the map to the new city
            map.flyTo({
                center: city.center,
                zoom: city.zoom,
                essential: true // This ensures the animation happens
            });
        
            // Fetch and display the city's border
            fetch(city.border_file)
                .then(response => response.json())
                .then(data => {
                    // Update the 'city-border-source' with the new data
                    map.getSource('city-border-source').setData(data);
                });
        }
        
        // Listen for changes on the dropdown
        cityDropdown.addEventListener('change', (e) => {
            selectCity(e.target.value);
        });
        
        
        // --- 3. MAP LOAD AND INTERACTIVITY SETUP ---
        map.on('load', () => {
        
            // --- SETUP SOURCES AND LAYERS ---
            // Source and layer for the city border
            map.addSource('city-border-source', { 'type': 'geojson', 'data': null });
            map.addLayer({
                'id': 'city-border-layer',
                'type': 'line',
                'source': 'city-border-source',
                'paint': { 'line-color': '#0000ff', 'line-width': 4, 'line-dasharray': [2, 2] }
            });
        
            // Source and layer for highlighting buildings
            map.addSource('highlight-building-source', { 'type': 'geojson', 'data': null });
            map.addLayer({
                'id': 'highlight-building-layer',
                'type': 'fill',
                'source': 'highlight-building-source',
                'paint': { 'fill-color': '#f08', 'fill-opacity': 0.6 }
            });
        
            // Source and layer for highlighting roads
            map.addSource('highlight-road-source', { 'type': 'geojson', 'data': null });
            map.addLayer({
                'id': 'highlight-road-layer',
                'type': 'line',
                'source': 'highlight-road-source',
                'paint': { 'line-color': '#33f', 'line-width': 4 }
            });
        
            // --- SETUP INITIAL STATE ---
            // Select the first city in the dropdown by default
            selectCity(cityDropdown.value);
        
        
            // --- SETUP CLICK HANDLER (IMPROVED VERSION) ---
            map.on('click', (e) => {
                // More comprehensive list of possible vector tile layers
                const possibleLayers = ['building', 'building-3d', 'road_major', 'road_minor', 'road_street', 'road_motorway', 'road_path', 'transportation'];
                const features = map.queryRenderedFeatures(e.point, { layers: possibleLayers });
        
                if (!features.length) { 
                    // Clear highlights if nothing was clicked
                    map.getSource('highlight-building-source').setData({ 'type': 'FeatureCollection', 'features': [] });
                    map.getSource('highlight-road-source').setData({ 'type': 'FeatureCollection', 'features': [] });
                    return; 
                }
        
                const clickedFeature = features[0];
                const layerId = clickedFeature.layer.id;
                
                // Use 'includes' for more robust matching
                if (layerId.includes('building')) {
                    map.getSource('highlight-building-source').setData(clickedFeature.geometry);
                    map.getSource('highlight-road-source').setData({ 'type': 'FeatureCollection', 'features': [] });
                } else if (layerId.includes('road') || layerId.includes('transportation')) {
                    map.getSource('highlight-road-source').setData(clickedFeature.geometry);
                    map.getSource('highlight-building-source').setData({ 'type': 'FeatureCollection', 'features': [] });
                }
            });
        });

    </script>

</body>
</html>
